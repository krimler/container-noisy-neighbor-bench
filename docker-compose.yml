services:
  # NO CPU LIMITS - using cpu_shares for relative weight only.
  # When total demand > available CPUs (2), shares determine distribution.
  # batch-processor gets 4x the share of regular services.
  # With no hard caps, a CPU-burning container WILL starve others.

  api-gateway:
    build: ./services
    container_name: api-gateway
    cpu_shares: 256
    environment:
      - SERVICE_NAME=api-gateway
      - PORT=5000
    ports:
      - "5001:5000"
    deploy:
      resources:
        limits:
          memory: 256M
    networks:
      - pocnet

  user-service:
    build: ./services
    container_name: user-service
    cpu_shares: 256
    environment:
      - SERVICE_NAME=user-service
      - PORT=5000
    ports:
      - "5002:5000"
    deploy:
      resources:
        limits:
          memory: 256M
    networks:
      - pocnet

  order-service:
    build: ./services
    container_name: order-service
    cpu_shares: 256
    environment:
      - SERVICE_NAME=order-service
      - PORT=5000
    ports:
      - "5003:5000"
    deploy:
      resources:
        limits:
          memory: 256M
    networks:
      - pocnet

  payment-service:
    build: ./services
    container_name: payment-service
    cpu_shares: 256
    environment:
      - SERVICE_NAME=payment-service
      - PORT=5000
    ports:
      - "5004:5000"
    deploy:
      resources:
        limits:
          memory: 256M
    networks:
      - pocnet

  batch-processor:
    build: ./services
    container_name: batch-processor
    cpu_shares: 1024
    environment:
      - SERVICE_NAME=batch-processor
      - PORT=5000
    ports:
      - "5005:5000"
    deploy:
      resources:
        limits:
          memory: 512M
    networks:
      - pocnet

networks:
  pocnet:
    driver: bridge
